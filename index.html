<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat â€” Sistema de Mensagens</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=IBM+Plex+Sans:ital,wght@0,300;0,400;0,500;0,600;1,300&display=swap');

:root {
  --bg: #0c0c0e;
  --bg2: #111115;
  --panel: #16161a;
  --border: #252530;
  --border2: #2e2e3a;
  --text: #e8e8f0;
  --text-dim: #6a6a80;
  --text-dimmer: #333340;
  --accent: #7c6af7;
  --accent-dim: #4a3fa0;
  --accent-glow: rgba(124,106,247,0.15);
  --green: #3ecf8e;
  --red: #f06060;
  --msg-own: #1e1a3a;
  --msg-other: #18181e;
}

* { margin:0; padding:0; box-sizing:border-box; }
html, body { height:100%; overflow:hidden; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'IBM Plex Sans', sans-serif;
  font-size: 14px;
  display: flex;
  flex-direction: column;
  height: 100vh;
}

/* â”€â”€ LOGIN SCREEN â”€â”€ */
#login-screen {
  position: fixed;
  inset: 0;
  background: var(--bg);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
  flex-direction: column;
  gap: 0;
  animation: fadeIn 0.4s ease;
}
@keyframes fadeIn { from { opacity:0; } to { opacity:1; } }

.login-box {
  background: var(--panel);
  border: 1px solid var(--border2);
  padding: 48px 52px;
  width: 100%;
  max-width: 400px;
  display: flex;
  flex-direction: column;
  gap: 20px;
  position: relative;
}
.login-box::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(to right, var(--accent-dim), var(--accent), var(--accent-dim));
}

.login-logo {
  font-family: 'Share Tech Mono', monospace;
  font-size: 11px;
  letter-spacing: 0.3em;
  color: var(--accent);
  text-transform: uppercase;
  margin-bottom: 4px;
}
.login-title {
  font-size: 22px;
  font-weight: 600;
  color: var(--text);
  line-height: 1.3;
}
.login-sub {
  font-size: 13px;
  color: var(--text-dim);
  font-style: italic;
  margin-top: -8px;
}

.login-field {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.login-field label {
  font-family: 'Share Tech Mono', monospace;
  font-size: 10px;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--text-dim);
}
.login-field input {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 2px;
  padding: 11px 14px;
  color: var(--text);
  font-family: 'IBM Plex Sans', sans-serif;
  font-size: 15px;
  outline: none;
  transition: border-color 0.2s;
  width: 100%;
}
.login-field input:focus { border-color: var(--accent); }
.login-field input::placeholder { color: var(--text-dimmer); }

.login-btn {
  background: var(--accent);
  border: none;
  padding: 12px;
  color: #fff;
  font-family: 'Share Tech Mono', monospace;
  font-size: 12px;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  cursor: pointer;
  transition: opacity 0.2s, transform 0.1s;
  margin-top: 4px;
}
.login-btn:hover { opacity: 0.85; }
.login-btn:active { transform: scale(0.98); }

/* â”€â”€ MAIN LAYOUT â”€â”€ */
#app {
  display: none;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
}
#app.visible { display: flex; }

/* TOP BAR */
.topbar {
  background: var(--panel);
  border-bottom: 1px solid var(--border);
  padding: 0 20px;
  height: 52px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
}
.topbar-left {
  display: flex;
  align-items: center;
  gap: 12px;
}
.topbar-logo {
  font-family: 'Share Tech Mono', monospace;
  font-size: 13px;
  letter-spacing: 0.15em;
  color: var(--accent);
}
.topbar-room {
  font-size: 13px;
  color: var(--text-dim);
  display: flex;
  align-items: center;
  gap: 6px;
}
.topbar-room::before {
  content: '';
  width: 6px; height: 6px;
  background: var(--green);
  border-radius: 50%;
  animation: blink 2s step-end infinite;
}
@keyframes blink { 50% { opacity: 0; } }

.topbar-right {
  display: flex;
  align-items: center;
  gap: 16px;
}
.user-badge {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: var(--text-dim);
}
.user-avatar {
  width: 28px; height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Share Tech Mono', monospace;
  font-size: 11px;
  font-weight: bold;
  color: #fff;
  flex-shrink: 0;
}
.btn-exit {
  background: transparent;
  border: 1px solid var(--border2);
  padding: 5px 14px;
  color: var(--text-dim);
  font-family: 'Share Tech Mono', monospace;
  font-size: 10px;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-exit:hover { border-color: var(--red); color: var(--red); }

/* ONLINE BAR */
.online-bar {
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  padding: 8px 20px;
  display: flex;
  align-items: center;
  gap: 16px;
  flex-shrink: 0;
  overflow-x: auto;
  scrollbar-width: none;
}
.online-bar::-webkit-scrollbar { display: none; }
.online-label {
  font-family: 'Share Tech Mono', monospace;
  font-size: 10px;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--text-dimmer);
  flex-shrink: 0;
}
.online-users {
  display: flex;
  gap: 10px;
  flex-wrap: nowrap;
}
.online-chip {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 3px 10px 3px 6px;
  border: 1px solid var(--border);
  border-radius: 20px;
  font-size: 12px;
  color: var(--text-dim);
  white-space: nowrap;
}
.online-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--green);
}

/* MESSAGES */
.messages-wrap {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 2px;
  scrollbar-width: thin;
  scrollbar-color: var(--border2) transparent;
}
.messages-wrap::-webkit-scrollbar { width: 4px; }
.messages-wrap::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

.msg-group {
  display: flex;
  flex-direction: column;
  margin-bottom: 12px;
}

.msg-meta {
  display: flex;
  align-items: baseline;
  gap: 10px;
  margin-bottom: 4px;
  padding: 0 4px;
}
.msg-author {
  font-weight: 600;
  font-size: 13px;
}
.msg-time {
  font-family: 'Share Tech Mono', monospace;
  font-size: 10px;
  color: var(--text-dimmer);
}

.msg-bubble {
  background: var(--msg-other);
  border: 1px solid var(--border);
  border-radius: 2px 8px 8px 8px;
  padding: 10px 14px;
  font-size: 14px;
  line-height: 1.6;
  color: var(--text);
  max-width: 680px;
  word-break: break-word;
  position: relative;
}

.msg-group.own {
  align-items: flex-end;
}
.msg-group.own .msg-meta {
  flex-direction: row-reverse;
}
.msg-group.own .msg-bubble {
  background: var(--msg-own);
  border-color: var(--accent-dim);
  border-radius: 8px 2px 8px 8px;
}

/* System messages */
.sys-msg {
  text-align: center;
  font-family: 'Share Tech Mono', monospace;
  font-size: 10px;
  letter-spacing: 0.1em;
  color: var(--text-dimmer);
  padding: 8px 0;
}
.sys-msg span { color: var(--accent-dim); }

/* Empty state */
.empty-state {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: var(--text-dimmer);
  gap: 12px;
  font-family: 'Share Tech Mono', monospace;
  font-size: 11px;
  letter-spacing: 0.15em;
  text-transform: uppercase;
}
.empty-icon { font-size: 32px; opacity: 0.3; }

/* INPUT */
.input-area {
  background: var(--panel);
  border-top: 1px solid var(--border);
  padding: 14px 20px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-shrink: 0;
}
.input-wrap {
  flex: 1;
  background: var(--bg2);
  border: 1px solid var(--border);
  display: flex;
  align-items: center;
  transition: border-color 0.2s;
}
.input-wrap:focus-within { border-color: var(--accent-dim); }
#msg-input {
  flex: 1;
  background: transparent;
  border: none;
  padding: 11px 16px;
  color: var(--text);
  font-family: 'IBM Plex Sans', sans-serif;
  font-size: 14px;
  outline: none;
}
#msg-input::placeholder { color: var(--text-dimmer); }
.char-count {
  padding: 0 12px;
  font-family: 'Share Tech Mono', monospace;
  font-size: 10px;
  color: var(--text-dimmer);
}
.send-btn {
  background: var(--accent);
  border: none;
  padding: 12px 22px;
  color: #fff;
  font-family: 'Share Tech Mono', monospace;
  font-size: 11px;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  cursor: pointer;
  transition: opacity 0.2s, transform 0.1s;
  flex-shrink: 0;
  height: 100%;
}
.send-btn:hover { opacity: 0.85; }
.send-btn:active { transform: scale(0.97); }
.send-btn:disabled { opacity: 0.3; cursor: not-allowed; }

/* TYPING */
.typing-bar {
  padding: 4px 20px;
  font-family: 'Share Tech Mono', monospace;
  font-size: 10px;
  color: var(--text-dimmer);
  letter-spacing: 0.1em;
  min-height: 22px;
  background: var(--panel);
  border-top: 1px solid var(--border);
  flex-shrink: 0;
}

/* Scrollbar */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-thumb { background: var(--border2); }

@media (max-width: 600px) {
  .login-box { padding: 32px 24px; }
  .topbar { padding: 0 12px; }
  .topbar-logo { display: none; }
  .messages-wrap { padding: 12px; }
  .input-area { padding: 10px 12px; }
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">// Sistema de Chat</div>
    <div class="login-title">Entre na conversa</div>
    <div class="login-sub">Escolha um nome para entrar na sala.</div>
    <div class="login-field">
      <label>Seu nome</label>
      <input type="text" id="name-input" placeholder="Ex: Connor McGragor" maxlength="32" autocomplete="off">
    </div>
    <button class="login-btn" id="enter-btn">Entrar na sala â†’</button>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="topbar">
    <div class="topbar-left">
      <div class="topbar-logo">CHAT</div>
      <div class="topbar-room" id="room-label">Sala geral â€” ao vivo</div>
    </div>
    <div class="topbar-right">
      <div class="user-badge">
        <div class="user-avatar" id="my-avatar"></div>
        <span id="my-name-display"></span>
      </div>
      <button class="btn-exit" id="exit-btn">Sair</button>
    </div>
  </div>

  <div class="online-bar">
    <div class="online-label">Online:</div>
    <div class="online-users" id="online-list"></div>
  </div>

  <div class="messages-wrap" id="messages">
    <div class="empty-state" id="empty-state">
      <div class="empty-icon">ðŸ’¬</div>
      <div>Nenhuma mensagem ainda</div>
      <div style="opacity:0.5">Seja o primeiro a falar</div>
    </div>
  </div>

  <div class="typing-bar" id="typing-bar"></div>

  <div class="input-area">
    <div class="input-wrap">
      <input type="text" id="msg-input" placeholder="Digite uma mensagem..." maxlength="500" autocomplete="off">
      <div class="char-count" id="char-count">500</div>
    </div>
    <button class="send-btn" id="send-btn" disabled>Enviar</button>
  </div>
</div>

<script>
// â”€â”€ COLOURS per user â”€â”€
const PALETTE = [
  '#7c6af7','#3ecf8e','#f0a060','#e8498a','#60c8f0',
  '#c8a03c','#a060f0','#f06080','#40b8b8','#e06040'
];

function hashColor(name) {
  let h = 0;
  for (let i = 0; i < name.length; i++) h = (h * 31 + name.charCodeAt(i)) % PALETTE.length;
  return PALETTE[h];
}

function initials(name) {
  return name.trim().split(/\s+/).map(w => w[0]).join('').slice(0,2).toUpperCase();
}

function timeStr(ts) {
  const d = new Date(ts);
  return d.toLocaleTimeString('pt-BR', { hour:'2-digit', minute:'2-digit' });
}

// â”€â”€ STATE â”€â”€
let myName = null;
let pollInterval = null;
let typingTimeout = null;
let lastMsgCount = 0;
let isTyping = false;

const STORAGE_KEY_MSGS    = 'chat-messages';
const STORAGE_KEY_ONLINE  = 'chat-online';
const STORAGE_KEY_TYPING  = 'chat-typing';
const MAX_MSGS = 200;
const ONLINE_TTL = 8000;   // 8s sem heartbeat = offline
const TYPING_TTL = 3000;

// â”€â”€ STORAGE HELPERS â”€â”€
async function storageGet(key) {
  try {
    const r = await window.storage.get(key, true);
    return r ? JSON.parse(r.value) : null;
  } catch { return null; }
}

async function storageSet(key, value) {
  try {
    await window.storage.set(key, JSON.stringify(value), true);
  } catch {}
}

// â”€â”€ ONLINE PRESENCE â”€â”€
async function heartbeat() {
  const online = (await storageGet(STORAGE_KEY_ONLINE)) || {};
  online[myName] = Date.now();
  // clean stale
  for (const k of Object.keys(online)) {
    if (Date.now() - online[k] > ONLINE_TTL) delete online[k];
  }
  await storageSet(STORAGE_KEY_ONLINE, online);
  renderOnline(online);
}

async function removePresence() {
  const online = (await storageGet(STORAGE_KEY_ONLINE)) || {};
  delete online[myName];
  await storageSet(STORAGE_KEY_ONLINE, online);

  // system message: left
  await postSystemMsg(`${myName} saiu da sala.`);
}

function renderOnline(online) {
  const list = document.getElementById('online-list');
  list.innerHTML = '';
  for (const name of Object.keys(online)) {
    const chip = document.createElement('div');
    chip.className = 'online-chip';
    chip.innerHTML = `<div class="online-dot" style="background:${hashColor(name)}"></div>${escHtml(name)}`;
    list.appendChild(chip);
  }
}

// â”€â”€ TYPING â”€â”€
async function setTyping(active) {
  const typing = (await storageGet(STORAGE_KEY_TYPING)) || {};
  if (active) {
    typing[myName] = Date.now();
  } else {
    delete typing[myName];
  }
  await storageSet(STORAGE_KEY_TYPING, typing);
}

async function renderTyping() {
  const typing = (await storageGet(STORAGE_KEY_TYPING)) || {};
  const now = Date.now();
  const active = Object.entries(typing)
    .filter(([n, t]) => n !== myName && now - t < TYPING_TTL)
    .map(([n]) => n);

  const bar = document.getElementById('typing-bar');
  if (active.length === 0) { bar.textContent = ''; return; }
  const names = active.map(n => escHtml(n)).join(', ');
  bar.innerHTML = `${names} ${active.length === 1 ? 'estÃ¡' : 'estÃ£o'} digitando...`;
}

// â”€â”€ MESSAGES â”€â”€
function escHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

async function postMsg(text) {
  const msgs = (await storageGet(STORAGE_KEY_MSGS)) || [];
  msgs.push({ id: Date.now() + Math.random(), name: myName, text, ts: Date.now(), type: 'msg' });
  if (msgs.length > MAX_MSGS) msgs.splice(0, msgs.length - MAX_MSGS);
  await storageSet(STORAGE_KEY_MSGS, msgs);
}

async function postSystemMsg(text) {
  const msgs = (await storageGet(STORAGE_KEY_MSGS)) || [];
  msgs.push({ id: Date.now() + Math.random(), text, ts: Date.now(), type: 'system' });
  if (msgs.length > MAX_MSGS) msgs.splice(0, msgs.length - MAX_MSGS);
  await storageSet(STORAGE_KEY_MSGS, msgs);
}

async function renderMessages() {
  const msgs = (await storageGet(STORAGE_KEY_MSGS)) || [];
  const container = document.getElementById('messages');
  const empty = document.getElementById('empty-state');

  if (msgs.length === lastMsgCount) return; // nothing new
  lastMsgCount = msgs.length;

  if (msgs.length === 0) {
    empty.style.display = 'flex';
    return;
  }
  empty.style.display = 'none';

  // Rebuild â€” simple approach (replace all)
  // Keep only non-group elements
  container.innerHTML = '';

  let prevName = null;
  let prevGroup = null;

  for (const msg of msgs) {
    if (msg.type === 'system') {
      const el = document.createElement('div');
      el.className = 'sys-msg';
      el.innerHTML = `<span>${escHtml(msg.text)}</span>`;
      container.appendChild(el);
      prevName = null; prevGroup = null;
      continue;
    }

    const isOwn = msg.name === myName;
    const color = hashColor(msg.name);

    if (msg.name !== prevName) {
      const group = document.createElement('div');
      group.className = 'msg-group' + (isOwn ? ' own' : '');

      const meta = document.createElement('div');
      meta.className = 'msg-meta';
      meta.innerHTML = `
        <span class="msg-author" style="color:${color}">${escHtml(msg.name)}</span>
        <span class="msg-time">${timeStr(msg.ts)}</span>
      `;
      group.appendChild(meta);
      container.appendChild(group);
      prevGroup = group;
      prevName = msg.name;
    }

    const bubble = document.createElement('div');
    bubble.className = 'msg-bubble';
    bubble.textContent = msg.text;
    if (prevGroup) prevGroup.appendChild(bubble);
  }

  // Scroll to bottom
  container.scrollTop = container.scrollHeight;
}

// â”€â”€ POLL â”€â”€
async function poll() {
  await renderMessages();
  await renderTyping();
  await heartbeat();
}

// â”€â”€ SEND â”€â”€
async function sendMessage() {
  const input = document.getElementById('msg-input');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  document.getElementById('char-count').textContent = '500';
  document.getElementById('send-btn').disabled = true;
  await setTyping(false);
  isTyping = false;
  await postMsg(text);
  await renderMessages();
}

// â”€â”€ LOGIN â”€â”€
async function enterChat() {
  const nameInput = document.getElementById('name-input');
  const name = nameInput.value.trim();
  if (!name) { nameInput.focus(); return; }

  myName = name;

  // Setup UI
  document.getElementById('my-name-display').textContent = name;
  const av = document.getElementById('my-avatar');
  av.textContent = initials(name);
  av.style.background = hashColor(name);

  // Show app
  document.getElementById('login-screen').style.display = 'none';
  const app = document.getElementById('app');
  app.classList.add('visible');

  // System: joined
  await postSystemMsg(`${myName} entrou na sala.`);

  // Start polling
  await poll();
  pollInterval = setInterval(poll, 1500);

  // Focus input
  document.getElementById('msg-input').focus();
}

// â”€â”€ EVENTS â”€â”€
document.getElementById('enter-btn').addEventListener('click', enterChat);
document.getElementById('name-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') enterChat();
});

document.getElementById('send-btn').addEventListener('click', sendMessage);
document.getElementById('msg-input').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});

document.getElementById('msg-input').addEventListener('input', async function() {
  const len = this.value.length;
  document.getElementById('char-count').textContent = 500 - len;
  document.getElementById('send-btn').disabled = len === 0;

  // Typing indicator
  if (!isTyping && len > 0) {
    isTyping = true;
    await setTyping(true);
  }
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(async () => {
    isTyping = false;
    await setTyping(false);
  }, 2000);
});

document.getElementById('exit-btn').addEventListener('click', async () => {
  clearInterval(pollInterval);
  await removePresence();
  await setTyping(false);
  myName = null;
  lastMsgCount = 0;
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('app').classList.remove('visible');
  document.getElementById('name-input').value = '';
});

// Cleanup on tab close
window.addEventListener('beforeunload', async () => {
  if (myName) {
    await removePresence();
    await setTyping(false);
  }
});
</script>
</body>
</html>
