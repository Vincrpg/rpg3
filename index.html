<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wallace Corp. â€” Chat</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=IBM+Plex+Sans:ital,wght@0,300;0,400;0,500;0,600;1,300&display=swap');
:root {
  --bg:#0c0c0e;--bg2:#111115;--panel:#16161a;
  --border:#252530;--border2:#2e2e3a;
  --text:#e8e8f0;--dim:#6a6a80;--dimmer:#333340;
  --accent:#7c6af7;--accent-d:#4a3fa0;
  --green:#3ecf8e;--red:#f06060;
  --own:#1e1a3a;--other:#18181e;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:'IBM Plex Sans',sans-serif;font-size:14px;display:flex;flex-direction:column;height:100vh;}

/* LOGIN */
#login-screen{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:100;}
.login-box{background:var(--panel);border:1px solid var(--border2);padding:52px 56px;width:100%;max-width:420px;display:flex;flex-direction:column;gap:24px;position:relative;}
.login-box::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(to right,var(--accent-d),var(--accent),var(--accent-d));}
.login-corp{font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:.4em;color:var(--accent);text-transform:uppercase;margin-bottom:-8px;}
.login-title{font-size:26px;font-weight:600;letter-spacing:-.5px;}
.login-sub{font-size:13px;color:var(--dim);font-style:italic;margin-top:-10px;}
.login-field{display:flex;flex-direction:column;gap:9px;}
.login-field label{font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:.2em;text-transform:uppercase;color:var(--dim);}
.login-field input{background:var(--bg2);border:1px solid var(--border);padding:12px 15px;color:var(--text);font-family:'IBM Plex Sans',sans-serif;font-size:15px;outline:none;transition:border-color .2s;width:100%;}
.login-field input:focus{border-color:var(--accent);}
.login-field input::placeholder{color:var(--dimmer);}
.login-btn{background:var(--accent);border:none;padding:13px;color:#fff;font-family:'Share Tech Mono',monospace;font-size:11px;letter-spacing:.25em;text-transform:uppercase;cursor:pointer;transition:opacity .2s;}
.login-btn:hover{opacity:.85;}
.login-btn:disabled{opacity:.4;cursor:not-allowed;}
.login-err{font-size:12px;color:var(--red);font-style:italic;display:none;text-align:center;}

/* APP */
#app{display:none;flex-direction:column;height:100vh;overflow:hidden;}
#app.visible{display:flex;}
.topbar{background:var(--panel);border-bottom:1px solid var(--border);padding:0 20px;height:54px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.topbar-left{display:flex;align-items:center;gap:14px;}
.topbar-corp{font-family:'Share Tech Mono',monospace;font-size:12px;letter-spacing:.2em;color:var(--accent);text-transform:uppercase;}
.topbar-divider{width:1px;height:18px;background:var(--border2);}
.topbar-status{font-size:12px;color:var(--dim);display:flex;align-items:center;gap:6px;}
.dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:blink 2s step-end infinite;}
.dot.off{background:var(--red);animation:none;}
@keyframes blink{50%{opacity:0;}}
.topbar-right{display:flex;align-items:center;gap:12px;}
.user-badge{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--dim);}
.avatar{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Share Tech Mono',monospace;font-size:11px;font-weight:bold;color:#fff;}
.btn-exit{background:transparent;border:1px solid var(--border2);padding:5px 14px;color:var(--dim);font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:.15em;text-transform:uppercase;cursor:pointer;transition:all .2s;}
.btn-exit:hover{border-color:var(--red);color:var(--red);}
.msgs{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:2px;scrollbar-width:thin;scrollbar-color:var(--border2) transparent;}
.msgs::-webkit-scrollbar{width:4px;}
.msgs::-webkit-scrollbar-thumb{background:var(--border2);}
.msg-group{display:flex;flex-direction:column;margin-bottom:12px;}
.msg-meta{display:flex;align-items:baseline;gap:10px;margin-bottom:4px;padding:0 4px;}
.msg-author{font-weight:600;font-size:13px;}
.msg-time{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--dimmer);}
.bubble{background:var(--other);border:1px solid var(--border);border-radius:2px 8px 8px 8px;padding:10px 14px;font-size:14px;line-height:1.6;max-width:680px;word-break:break-word;}
.msg-group.own{align-items:flex-end;}
.msg-group.own .msg-meta{flex-direction:row-reverse;}
.msg-group.own .bubble{background:var(--own);border-color:var(--accent-d);border-radius:8px 2px 8px 8px;}
.sys-msg{text-align:center;font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:.1em;color:var(--dimmer);padding:8px 0;}
.sys-msg span{color:var(--accent-d);}
.empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--dimmer);gap:12px;font-family:'Share Tech Mono',monospace;font-size:11px;letter-spacing:.15em;text-transform:uppercase;}
.typing-bar{padding:4px 20px;font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--dimmer);letter-spacing:.1em;min-height:22px;background:var(--panel);border-top:1px solid var(--border);flex-shrink:0;}
.input-area{background:var(--panel);border-top:1px solid var(--border);padding:14px 20px;display:flex;align-items:center;gap:12px;flex-shrink:0;}
.input-wrap{flex:1;background:var(--bg2);border:1px solid var(--border);display:flex;align-items:center;transition:border-color .2s;}
.input-wrap:focus-within{border-color:var(--accent-d);}
#msg-input{flex:1;background:transparent;border:none;padding:11px 16px;color:var(--text);font-family:'IBM Plex Sans',sans-serif;font-size:14px;outline:none;}
#msg-input::placeholder{color:var(--dimmer);}
.char-count{padding:0 12px;font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--dimmer);}
.send-btn{background:var(--accent);border:none;padding:12px 22px;color:#fff;font-family:'Share Tech Mono',monospace;font-size:11px;letter-spacing:.15em;text-transform:uppercase;cursor:pointer;transition:opacity .2s;flex-shrink:0;}
.send-btn:hover{opacity:.85;}
.send-btn:disabled{opacity:.3;cursor:not-allowed;}
@media(max-width:600px){
  .login-box{padding:36px 28px;}
  .topbar{padding:0 12px;}
  .msgs{padding:12px;}
  .input-area{padding:10px 12px;}
  .topbar-corp{display:none;}
  .topbar-divider{display:none;}
}
</style>
</head>
<body>

<div id="login-screen">
  <div class="login-box">
    <div class="login-corp">// Wallace Corp.</div>
    <div class="login-title">Entre na conversa</div>
    <div class="login-sub">Identifique-se para acessar a sala.</div>
    <div class="login-field">
      <label>Seu nome</label>
      <input type="text" id="name-input" placeholder="Ex: Connor McGragor" maxlength="32" autocomplete="off">
    </div>
    <div class="login-err" id="login-err">Erro ao conectar. Tente novamente.</div>
    <button class="login-btn" id="enter-btn">Acessar sala â†’</button>
  </div>
</div>

<div id="app">
  <div class="topbar">
    <div class="topbar-left">
      <span class="topbar-corp">Wallace Corp.</span>
      <div class="topbar-divider"></div>
      <div class="topbar-status">
        <div class="dot" id="status-dot"></div>
        <span id="status-text">Conectando...</span>
      </div>
    </div>
    <div class="topbar-right">
      <div class="user-badge">
        <div class="avatar" id="my-avatar"></div>
        <span id="my-name-display"></span>
      </div>
      <button class="btn-exit" id="exit-btn">Sair</button>
    </div>
  </div>

  <div class="msgs" id="messages">
    <div class="empty" id="empty-state">
      <div style="font-size:32px;opacity:.3">ðŸ’¬</div>
      <div>Nenhuma mensagem ainda</div>
      <div style="opacity:.5">Seja o primeiro a falar</div>
    </div>
  </div>

  <div class="typing-bar" id="typing-bar"></div>

  <div class="input-area">
    <div class="input-wrap">
      <input type="text" id="msg-input" placeholder="Digite uma mensagem..." maxlength="400" autocomplete="off">
      <div class="char-count" id="char-count">400</div>
    </div>
    <button class="send-btn" id="send-btn" disabled>Enviar</button>
  </div>
</div>

<script>
const SUPABASE_URL  = 'https://erpchtbxnymgvlslherb.supabase.co';
const SUPABASE_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVycGNodGJ4bnltZ3Zsc2xoZXJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NjI0MzUsImV4cCI6MjA4NzAzODQzNX0.dxl4aYpvu6DbHEn26CAC2MutnXYskd54j6eBor3STlk';

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const PAL = ['#7c6af7','#3ecf8e','#f0a060','#e8498a','#60c8f0','#c8a03c','#a060f0','#f06080','#40b8b8','#e06040'];
const hc  = n => { let h=0; for(const c of n) h=(h*31+c.charCodeAt(0))%PAL.length; return PAL[h]; };
const ini = n => n.trim().split(/\s+/).map(w=>w[0]).join('').slice(0,2).toUpperCase();
const fmtT = t => new Date(t).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
const esc  = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

let myName = null;
let typingTimer = null;
let typingUsers = {};
let typingInterval = null;
let channel = null;

function setStatus(ok) {
  document.getElementById('status-dot').className = 'dot'+(ok?'':' off');
  document.getElementById('status-text').textContent = ok ? 'Ao vivo' : 'Reconectando...';
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function appendMessage(m) {
  const c = document.getElementById('messages');
  document.getElementById('empty-state').style.display = 'none';

  if (m.type === 'system') {
    const el = document.createElement('div');
    el.className = 'sys-msg';
    el.innerHTML = `<span>${esc(m.text)}</span>`;
    c.appendChild(el);
    c.scrollTop = c.scrollHeight;
    return;
  }

  // Check if last group is same author
  const lastGroup = c.querySelector('.msg-group:last-of-type');
  const own = m.name === myName;

  if (lastGroup && lastGroup.dataset.author === m.name) {
    const b = document.createElement('div');
    b.className = 'bubble';
    b.textContent = m.text;
    lastGroup.appendChild(b);
  } else {
    const group = document.createElement('div');
    group.className = 'msg-group'+(own?' own':'');
    group.dataset.author = m.name;
    const meta = document.createElement('div');
    meta.className = 'msg-meta';
    meta.innerHTML = `<span class="msg-author" style="color:${hc(m.name)}">${esc(m.name)}</span><span class="msg-time">${fmtT(m.ts)}</span>`;
    group.appendChild(meta);
    const b = document.createElement('div');
    b.className = 'bubble';
    b.textContent = m.text;
    group.appendChild(b);
    c.appendChild(group);
  }
  c.scrollTop = c.scrollHeight;
}

function renderAllMessages(msgs) {
  const c = document.getElementById('messages');
  [...c.children].forEach(ch => { if(ch.id !== 'empty-state') ch.remove(); });
  document.getElementById('empty-state').style.display = msgs.length ? 'none' : 'flex';
  for (const m of msgs) appendMessage(m);
}

function updateTypingBar() {
  const now = Date.now();
  const active = Object.entries(typingUsers)
    .filter(([n,t]) => n !== myName && now-t < 4000)
    .map(([n]) => n);
  document.getElementById('typing-bar').textContent = active.length
    ? `${active.join(', ')} ${active.length===1?'estÃ¡':'estÃ£o'} digitando...` : '';
}

// â”€â”€ Load history â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadHistory() {
  const { data, error } = await sb
    .from('messages')
    .select('*')
    .order('ts', { ascending: true })
    .limit(200);
  if (!error && data) renderAllMessages(data);
}

// â”€â”€ Realtime â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function subscribeRealtime() {
  channel = sb
    .channel('wallace-chat')
    .on('postgres_changes', {
      event: 'INSERT',
      schema: 'public',
      table: 'messages'
    }, payload => {
      appendMessage(payload.new);
      setStatus(true);
    })
    .on('broadcast', { event: 'typing' }, payload => {
      if (payload.payload.name !== myName) {
        typingUsers[payload.payload.name] = Date.now();
        updateTypingBar();
      }
    })
    .subscribe(status => {
      setStatus(status === 'SUBSCRIBED');
    });
}

// â”€â”€ Send â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendMessage() {
  const inp = document.getElementById('msg-input');
  const text = inp.value.trim();
  if (!text) return;
  inp.value = '';
  document.getElementById('char-count').textContent = '400';
  document.getElementById('send-btn').disabled = true;
  await sb.from('messages').insert({ name: myName, text, type: 'msg', ts: Date.now() });
}

async function sendSystem(text) {
  await sb.from('messages').insert({ name: '_system', text, type: 'system', ts: Date.now() });
}

function broadcastTyping() {
  if (!channel) return;
  channel.send({ type: 'broadcast', event: 'typing', payload: { name: myName } });
}

// â”€â”€ Enter / Exit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function enterChat() {
  const name = document.getElementById('name-input').value.trim();
  if (!name) return;
  const btn = document.getElementById('enter-btn');
  const err = document.getElementById('login-err');
  btn.textContent='Conectando...'; btn.disabled=true; err.style.display='none';
  try {
    myName = name;
    document.getElementById('my-name-display').textContent = name;
    const av = document.getElementById('my-avatar');
    av.textContent = ini(name); av.style.background = hc(name);

    await loadHistory();
    subscribeRealtime();

    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app').classList.add('visible');
    document.getElementById('msg-input').focus();

    // Send join message after short delay so subscription is ready
    setTimeout(() => sendSystem(`${name} entrou na sala.`), 800);

    // Clean typing indicator periodically
    typingInterval = setInterval(updateTypingBar, 1000);

  } catch(e) {
    console.error(e);
    err.style.display='block';
    btn.textContent='Acessar sala â†’'; btn.disabled=false; myName=null;
  }
}

async function exitChat() {
  clearInterval(typingInterval);
  await sendSystem(`${myName} saiu da sala.`);
  if (channel) sb.removeChannel(channel);
  myName = null; typingUsers = {};
  document.getElementById('app').classList.remove('visible');
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('name-input').value = '';
  document.getElementById('enter-btn').textContent = 'Acessar sala â†’';
  document.getElementById('enter-btn').disabled = false;
  document.getElementById('messages').innerHTML = '<div class="empty" id="empty-state"><div style="font-size:32px;opacity:.3">ðŸ’¬</div><div>Nenhuma mensagem ainda</div><div style="opacity:.5">Seja o primeiro a falar</div></div>';
}

// â”€â”€ Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('enter-btn').addEventListener('click', enterChat);
document.getElementById('name-input').addEventListener('keydown', e => { if(e.key==='Enter') enterChat(); });
document.getElementById('send-btn').addEventListener('click', sendMessage);
document.getElementById('msg-input').addEventListener('keydown', e => {
  if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendMessage(); }
});
document.getElementById('msg-input').addEventListener('input', function() {
  const len = this.value.length;
  document.getElementById('char-count').textContent = 400-len;
  document.getElementById('send-btn').disabled = len === 0;
  clearTimeout(typingTimer);
  if (len > 0) { broadcastTyping(); typingTimer = setTimeout(broadcastTyping, 2000); }
});
document.getElementById('exit-btn').addEventListener('click', exitChat);
window.addEventListener('beforeunload', () => { if(myName) sendSystem(`${myName} saiu da sala.`); });
</script>
</body>
</html>
