<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat â€” Sistema de Mensagens</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=IBM+Plex+Sans:ital,wght@0,300;0,400;0,500;0,600;1,300&display=swap');

:root {
  --bg: #0c0c0e; --bg2: #111115; --panel: #16161a;
  --border: #252530; --border2: #2e2e3a;
  --text: #e8e8f0; --text-dim: #6a6a80; --text-dimmer: #333340;
  --accent: #7c6af7; --accent-dim: #4a3fa0;
  --green: #3ecf8e; --red: #f06060;
  --msg-own: #1e1a3a; --msg-other: #18181e;
}
* { margin:0; padding:0; box-sizing:border-box; }
html, body { height:100%; overflow:hidden; }
body {
  background:var(--bg); color:var(--text);
  font-family:'IBM Plex Sans',sans-serif; font-size:14px;
  display:flex; flex-direction:column; height:100vh;
}

/* LOGIN */
#login-screen {
  position:fixed; inset:0; background:var(--bg);
  display:flex; align-items:center; justify-content:center; z-index:100;
}
.login-box {
  background:var(--panel); border:1px solid var(--border2);
  padding:48px 52px; width:100%; max-width:400px;
  display:flex; flex-direction:column; gap:20px; position:relative;
}
.login-box::before {
  content:''; position:absolute; top:0; left:0; right:0; height:2px;
  background:linear-gradient(to right, var(--accent-dim), var(--accent), var(--accent-dim));
}
.login-logo { font-family:'Share Tech Mono',monospace; font-size:11px; letter-spacing:0.3em; color:var(--accent); text-transform:uppercase; }
.login-title { font-size:22px; font-weight:600; color:var(--text); }
.login-sub { font-size:13px; color:var(--text-dim); font-style:italic; margin-top:-8px; }
.login-field { display:flex; flex-direction:column; gap:8px; }
.login-field label { font-family:'Share Tech Mono',monospace; font-size:10px; letter-spacing:0.2em; text-transform:uppercase; color:var(--text-dim); }
.login-field input {
  background:var(--bg2); border:1px solid var(--border); padding:11px 14px;
  color:var(--text); font-family:'IBM Plex Sans',sans-serif; font-size:15px;
  outline:none; transition:border-color 0.2s; width:100%;
}
.login-field input:focus { border-color:var(--accent); }
.login-field input::placeholder { color:var(--text-dimmer); }
.login-btn {
  background:var(--accent); border:none; padding:12px; color:#fff;
  font-family:'Share Tech Mono',monospace; font-size:12px; letter-spacing:0.2em;
  text-transform:uppercase; cursor:pointer; transition:opacity 0.2s;
}
.login-btn:hover { opacity:0.85; }
.login-btn:disabled { opacity:0.5; cursor:not-allowed; }
.login-err { font-size:12px; color:var(--red); font-style:italic; display:none; text-align:center; }

/* APP */
#app { display:none; flex-direction:column; height:100vh; overflow:hidden; }
#app.visible { display:flex; }

.topbar {
  background:var(--panel); border-bottom:1px solid var(--border);
  padding:0 20px; height:52px; display:flex; align-items:center;
  justify-content:space-between; flex-shrink:0;
}
.topbar-logo { font-family:'Share Tech Mono',monospace; font-size:13px; letter-spacing:0.15em; color:var(--accent); }
.topbar-status { font-size:12px; color:var(--text-dim); display:flex; align-items:center; gap:6px; }
.dot { width:6px; height:6px; border-radius:50%; background:var(--green); animation:blink 2s step-end infinite; }
@keyframes blink { 50% { opacity:0; } }
.topbar-right { display:flex; align-items:center; gap:14px; }
.user-badge { display:flex; align-items:center; gap:8px; font-size:13px; color:var(--text-dim); }
.user-avatar {
  width:28px; height:28px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-family:'Share Tech Mono',monospace; font-size:11px; font-weight:bold; color:#fff;
}
.btn-exit {
  background:transparent; border:1px solid var(--border2); padding:5px 14px;
  color:var(--text-dim); font-family:'Share Tech Mono',monospace;
  font-size:10px; letter-spacing:0.15em; text-transform:uppercase;
  cursor:pointer; transition:all 0.2s;
}
.btn-exit:hover { border-color:var(--red); color:var(--red); }

.messages-wrap {
  flex:1; overflow-y:auto; padding:20px;
  display:flex; flex-direction:column; gap:2px;
  scrollbar-width:thin; scrollbar-color:var(--border2) transparent;
}
.messages-wrap::-webkit-scrollbar { width:4px; }
.messages-wrap::-webkit-scrollbar-thumb { background:var(--border2); }

.msg-group { display:flex; flex-direction:column; margin-bottom:12px; }
.msg-meta { display:flex; align-items:baseline; gap:10px; margin-bottom:4px; padding:0 4px; }
.msg-author { font-weight:600; font-size:13px; }
.msg-time { font-family:'Share Tech Mono',monospace; font-size:10px; color:var(--text-dimmer); }
.msg-bubble {
  background:var(--msg-other); border:1px solid var(--border);
  border-radius:2px 8px 8px 8px; padding:10px 14px;
  font-size:14px; line-height:1.6; color:var(--text);
  max-width:680px; word-break:break-word;
}
.msg-group.own { align-items:flex-end; }
.msg-group.own .msg-meta { flex-direction:row-reverse; }
.msg-group.own .msg-bubble { background:var(--msg-own); border-color:var(--accent-dim); border-radius:8px 2px 8px 8px; }

.sys-msg { text-align:center; font-family:'Share Tech Mono',monospace; font-size:10px; letter-spacing:0.1em; color:var(--text-dimmer); padding:8px 0; }
.sys-msg span { color:var(--accent-dim); }

.empty-state {
  flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
  color:var(--text-dimmer); gap:12px; font-family:'Share Tech Mono',monospace;
  font-size:11px; letter-spacing:0.15em; text-transform:uppercase;
}
.empty-icon { font-size:32px; opacity:0.3; }

.typing-bar {
  padding:4px 20px; font-family:'Share Tech Mono',monospace; font-size:10px;
  color:var(--text-dimmer); letter-spacing:0.1em; min-height:22px;
  background:var(--panel); border-top:1px solid var(--border); flex-shrink:0;
}
.input-area {
  background:var(--panel); border-top:1px solid var(--border);
  padding:14px 20px; display:flex; align-items:center; gap:12px; flex-shrink:0;
}
.input-wrap {
  flex:1; background:var(--bg2); border:1px solid var(--border);
  display:flex; align-items:center; transition:border-color 0.2s;
}
.input-wrap:focus-within { border-color:var(--accent-dim); }
#msg-input {
  flex:1; background:transparent; border:none; padding:11px 16px;
  color:var(--text); font-family:'IBM Plex Sans',sans-serif; font-size:14px; outline:none;
}
#msg-input::placeholder { color:var(--text-dimmer); }
.char-count { padding:0 12px; font-family:'Share Tech Mono',monospace; font-size:10px; color:var(--text-dimmer); }
.send-btn {
  background:var(--accent); border:none; padding:12px 22px; color:#fff;
  font-family:'Share Tech Mono',monospace; font-size:11px; letter-spacing:0.15em;
  text-transform:uppercase; cursor:pointer; transition:opacity 0.2s; flex-shrink:0;
}
.send-btn:hover { opacity:0.85; }
.send-btn:disabled { opacity:0.3; cursor:not-allowed; }

@media (max-width:600px) {
  .login-box { padding:32px 24px; }
  .topbar { padding:0 12px; }
  .messages-wrap { padding:12px; }
  .input-area { padding:10px 12px; }
  .topbar-logo { display:none; }
}
</style>
</head>
<body>

<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">// Sistema de Chat</div>
    <div class="login-title">Entre na conversa</div>
    <div class="login-sub">Escolha um nome para entrar na sala.</div>
    <div class="login-field">
      <label>Seu nome</label>
      <input type="text" id="name-input" placeholder="Ex: Connor McGragor" maxlength="32" autocomplete="off">
    </div>
    <div class="login-err" id="login-err">Erro ao conectar. Tente novamente.</div>
    <button class="login-btn" id="enter-btn">Entrar na sala â†’</button>
  </div>
</div>

<div id="app">
  <div class="topbar">
    <div style="display:flex;align-items:center;gap:12px">
      <div class="topbar-logo">CHAT</div>
      <div class="topbar-status"><div class="dot" id="status-dot"></div><span id="status-text">Conectando...</span></div>
    </div>
    <div class="topbar-right">
      <div class="user-badge">
        <div class="user-avatar" id="my-avatar"></div>
        <span id="my-name-display"></span>
      </div>
      <button class="btn-exit" id="exit-btn">Sair</button>
    </div>
  </div>

  <div class="messages-wrap" id="messages">
    <div class="empty-state" id="empty-state">
      <div class="empty-icon">ðŸ’¬</div>
      <div>Nenhuma mensagem ainda</div>
      <div style="opacity:0.5">Seja o primeiro a falar</div>
    </div>
  </div>

  <div class="typing-bar" id="typing-bar"></div>

  <div class="input-area">
    <div class="input-wrap">
      <input type="text" id="msg-input" placeholder="Digite uma mensagem..." maxlength="400" autocomplete="off">
      <div class="char-count" id="char-count">400</div>
    </div>
    <button class="send-btn" id="send-btn" disabled>Enviar</button>
  </div>
</div>

<script>
const MAX_MSGS = 150;
const POLL_MS  = 2500;
const STORAGE_KEY = 'chat-data';

const PALETTE = ['#7c6af7','#3ecf8e','#f0a060','#e8498a','#60c8f0','#c8a03c','#a060f0','#f06080','#40b8b8','#e06040'];
function hashColor(n) { let h=0; for(let i=0;i<n.length;i++) h=(h*31+n.charCodeAt(i))%PALETTE.length; return PALETTE[h]; }
function initials(n) { return n.trim().split(/\s+/).map(w=>w[0]).join('').slice(0,2).toUpperCase(); }
function timeStr(ts) { return new Date(ts).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}); }
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

let myName=null, pollTimer=null, lastCount=-1, typingTimer=null;

// Storage helpers using window.storage (shared=true for multi-user)
async function readData() {
  try {
    const result = await window.storage.get(STORAGE_KEY, true);
    return result ? JSON.parse(result.value) : { messages: [], typing: {} };
  } catch {
    return { messages: [], typing: {} };
  }
}

async function writeData(data) {
  await window.storage.set(STORAGE_KEY, JSON.stringify(data), true);
}

function renderMessages(msgs) {
  if (msgs.length === lastCount) return;
  lastCount = msgs.length;
  const container = document.getElementById('messages');
  document.getElementById('empty-state').style.display = msgs.length ? 'none' : 'flex';
  container.innerHTML = '';
  let prevName=null, prevGroup=null;
  for (const msg of msgs) {
    if (msg.type === 'system') {
      const el = document.createElement('div');
      el.className = 'sys-msg';
      el.innerHTML = `<span>${esc(msg.text)}</span>`;
      container.appendChild(el);
      prevName=null; prevGroup=null; continue;
    }
    const isOwn = msg.name === myName;
    if (msg.name !== prevName) {
      prevGroup = document.createElement('div');
      prevGroup.className = 'msg-group' + (isOwn?' own':'');
      const meta = document.createElement('div');
      meta.className = 'msg-meta';
      meta.innerHTML = `<span class="msg-author" style="color:${hashColor(msg.name)}">${esc(msg.name)}</span><span class="msg-time">${timeStr(msg.ts)}</span>`;
      prevGroup.appendChild(meta);
      container.appendChild(prevGroup);
      prevName = msg.name;
    }
    const bubble = document.createElement('div');
    bubble.className = 'msg-bubble';
    bubble.textContent = msg.text;
    prevGroup.appendChild(bubble);
  }
  container.scrollTop = container.scrollHeight;
}

function renderTyping(typing) {
  const now = Date.now();
  const active = Object.entries(typing||{}).filter(([n,t])=>n!==myName&&now-t<4000).map(([n])=>n);
  document.getElementById('typing-bar').textContent = active.length
    ? `${active.join(', ')} ${active.length===1?'estÃ¡':'estÃ£o'} digitando...` : '';
}

function setStatus(online) {
  document.getElementById('status-dot').style.background = online ? 'var(--green)' : 'var(--red)';
  document.getElementById('status-text').textContent = online ? 'Ao vivo' : 'Reconectando...';
}

async function poll() {
  try {
    const record = await readData();
    renderMessages(record.messages||[]);
    renderTyping(record.typing||{});
    setStatus(true);
  } catch { setStatus(false); }
}

async function sendMessage() {
  const input = document.getElementById('msg-input');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  document.getElementById('char-count').textContent = '400';
  document.getElementById('send-btn').disabled = true;
  try {
    const record = await readData();
    const msgs = record.messages || [];
    msgs.push({ name:myName, text, ts:Date.now(), type:'msg' });
    if (msgs.length > MAX_MSGS) msgs.splice(0, msgs.length - MAX_MSGS);
    const typing = record.typing || {};
    delete typing[myName];
    await writeData({ messages:msgs, typing });
    lastCount = -1;
    await poll();
  } catch(e) { console.error(e); }
}

async function updateTyping(active) {
  try {
    const record = await readData();
    const typing = record.typing || {};
    if (active) typing[myName] = Date.now(); else delete typing[myName];
    await writeData({ ...record, typing });
  } catch {}
}

async function enterChat() {
  const nameInput = document.getElementById('name-input');
  const name = nameInput.value.trim();
  if (!name) { nameInput.focus(); return; }
  const btn = document.getElementById('enter-btn');
  btn.textContent = 'Conectando...'; btn.disabled = true;
  document.getElementById('login-err').style.display = 'none';
  try {
    myName = name;
    document.getElementById('my-name-display').textContent = name;
    const av = document.getElementById('my-avatar');
    av.textContent = initials(name); av.style.background = hashColor(name);
    // join message
    const record = await readData();
    const msgs = record.messages || [];
    msgs.push({ type:'system', text:`${name} entrou na sala.`, ts:Date.now() });
    await writeData({ messages:msgs, typing: record.typing||{} });
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app').classList.add('visible');
    lastCount = -1;
    await poll();
    pollTimer = setInterval(poll, POLL_MS);
    document.getElementById('msg-input').focus();
  } catch(e) {
    console.error(e);
    document.getElementById('login-err').style.display = 'block';
    btn.textContent = 'Entrar na sala â†’'; btn.disabled = false;
    myName = null;
  }
}

async function exitChat() {
  clearInterval(pollTimer);
  try {
    const record = await readData();
    const msgs = record.messages || [];
    msgs.push({ type:'system', text:`${myName} saiu da sala.`, ts:Date.now() });
    const typing = record.typing || {};
    delete typing[myName];
    await writeData({ messages:msgs, typing });
  } catch {}
  myName=null; lastCount=-1;
  document.getElementById('login-screen').style.display='flex';
  document.getElementById('app').classList.remove('visible');
  document.getElementById('name-input').value='';
  document.getElementById('enter-btn').textContent='Entrar na sala â†’';
  document.getElementById('enter-btn').disabled=false;
}

// Events
document.getElementById('enter-btn').addEventListener('click', enterChat);
document.getElementById('name-input').addEventListener('keydown', e=>{ if(e.key==='Enter') enterChat(); });
document.getElementById('send-btn').addEventListener('click', sendMessage);
document.getElementById('msg-input').addEventListener('keydown', e=>{ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();} });
document.getElementById('msg-input').addEventListener('input', function() {
  const len = this.value.length;
  document.getElementById('char-count').textContent = 400 - len;
  document.getElementById('send-btn').disabled = len === 0;
  clearTimeout(typingTimer);
  if (len > 0) { updateTyping(true); typingTimer = setTimeout(()=>updateTyping(false), 2500); }
  else updateTyping(false);
});
document.getElementById('exit-btn').addEventListener('click', exitChat);
window.addEventListener('beforeunload', ()=>{ if(myName) updateTyping(false); });
</script>
</body>
</html>
